"use strict";(self.webpackChunkcosmos_sdk_docs=self.webpackChunkcosmos_sdk_docs||[]).push([[15564],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>h});var n=r(67294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=n.createContext({}),c=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},u=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=c(r),m=a,h=d["".concat(s,".").concat(m)]||d[m]||p[m]||o;return r?n.createElement(h,i(i({ref:t},u),{},{components:r})):n.createElement(h,i({ref:t},u))}));function h(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:a,i[1]=l;for(var c=2;c<o;c++)i[c]=r[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},9043:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var n=r(87462),a=(r(67294),r(3905));const o={},i="ADR 068: Preblock",l={unversionedId:"build/architecture/adr-068-preblock",id:"version-0.53/build/architecture/adr-068-preblock",title:"ADR 068: Preblock",description:"Changelog",source:"@site/versioned_docs/version-0.53/build/architecture/adr-068-preblock.md",sourceDirName:"build/architecture",slug:"/build/architecture/adr-068-preblock",permalink:"/v0.53/build/architecture/adr-068-preblock",draft:!1,tags:[],version:"0.53",frontMatter:{},sidebar:"buildSidebar",previous:{title:"ADR-065: Store V2",permalink:"/v0.53/build/architecture/adr-065-store-v2"},next:{title:"ADR 070: Unordered Transactions",permalink:"/v0.53/build/architecture/adr-070-unordered-account"}},s={},c=[{value:"Changelog",id:"changelog",level:2},{value:"Status",id:"status",level:2},{value:"Abstract",id:"abstract",level:2},{value:"Context",id:"context",level:2},{value:"Alternatives",id:"alternatives",level:2},{value:"Decision",id:"decision",level:2},{value:"<code>PreBlocker</code>",id:"preblocker",level:3},{value:"Consequences",id:"consequences",level:2},{value:"Backwards Compatibility",id:"backwards-compatibility",level:3},{value:"Positive",id:"positive",level:3},{value:"Negative",id:"negative",level:3},{value:"Neutral",id:"neutral",level:3},{value:"Further Discussions",id:"further-discussions",level:2},{value:"Test Cases",id:"test-cases",level:2},{value:"References",id:"references",level:2}],u={toc:c},d="wrapper";function p(e){let{components:t,...r}=e;return(0,a.kt)(d,(0,n.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"adr-068-preblock"},"ADR 068: Preblock"),(0,a.kt)("h2",{id:"changelog"},"Changelog"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Sept 13, 2023: Initial Draft")),(0,a.kt)("h2",{id:"status"},"Status"),(0,a.kt)("p",null,"DRAFT"),(0,a.kt)("h2",{id:"abstract"},"Abstract"),(0,a.kt)("p",null,"Introduce ",(0,a.kt)("inlineCode",{parentName:"p"},"PreBlock"),", which runs before begin blocker other modules, and allows to modify consensus parameters, and the changes are visible to the following state machine logics."),(0,a.kt)("h2",{id:"context"},"Context"),(0,a.kt)("p",null,"When upgrading to sdk 0.47, the storage format for consensus parameters changed, but in the migration block, ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.ConsensusParams()")," is always ",(0,a.kt)("inlineCode",{parentName:"p"},"nil"),", because it fails to load the old format using new code, it's supposed to be migrated by the ",(0,a.kt)("inlineCode",{parentName:"p"},"x/upgrade")," module first, but unfortunately, the migration happens in ",(0,a.kt)("inlineCode",{parentName:"p"},"BeginBlocker")," handler, which runs after the ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx")," is initialized.\nWhen we try to solve this, we find the ",(0,a.kt)("inlineCode",{parentName:"p"},"x/upgrade")," module can't modify the context to make the consensus parameters visible for the other modules, the context is passed by value, and sdk team want to keep it that way, that's good for isolations between modules."),(0,a.kt)("h2",{id:"alternatives"},"Alternatives"),(0,a.kt)("p",null,"The first alternative solution introduced a ",(0,a.kt)("inlineCode",{parentName:"p"},"MigrateModuleManager"),", which only includes the ",(0,a.kt)("inlineCode",{parentName:"p"},"x/upgrade")," module right now, and baseapp will run their ",(0,a.kt)("inlineCode",{parentName:"p"},"BeginBlocker"),"s before the other modules, and reload context's consensus parameters in between."),(0,a.kt)("h2",{id:"decision"},"Decision"),(0,a.kt)("p",null,"Suggested this new lifecycle method."),(0,a.kt)("h3",{id:"preblocker"},(0,a.kt)("inlineCode",{parentName:"h3"},"PreBlocker")),(0,a.kt)("p",null,"There are two semantics around the new lifecycle method:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"It runs before the ",(0,a.kt)("inlineCode",{parentName:"li"},"BeginBlocker")," of all modules"),(0,a.kt)("li",{parentName:"ul"},"It can modify consensus parameters in storage, and signal the caller through the return value.")),(0,a.kt)("p",null,"When it returns ",(0,a.kt)("inlineCode",{parentName:"p"},"ConsensusParamsChanged=true"),", the caller must refresh the consensus parameter in the finalize context:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"app.finalizeBlockState.ctx = app.finalizeBlockState.ctx.WithConsensusParams(app.GetConsensusParams())\n")),(0,a.kt)("p",null,"The new ctx must be passed to all the other lifecycle methods."),(0,a.kt)("h2",{id:"consequences"},"Consequences"),(0,a.kt)("h3",{id:"backwards-compatibility"},"Backwards Compatibility"),(0,a.kt)("h3",{id:"positive"},"Positive"),(0,a.kt)("h3",{id:"negative"},"Negative"),(0,a.kt)("h3",{id:"neutral"},"Neutral"),(0,a.kt)("h2",{id:"further-discussions"},"Further Discussions"),(0,a.kt)("h2",{id:"test-cases"},"Test Cases"),(0,a.kt)("h2",{id:"references"},"References"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"[1]"," ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/cosmos/cosmos-sdk/issues/16494"},"https://github.com/cosmos/cosmos-sdk/issues/16494")),(0,a.kt)("li",{parentName:"ul"},"[2]"," ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/cosmos/cosmos-sdk/pull/16583"},"https://github.com/cosmos/cosmos-sdk/pull/16583")),(0,a.kt)("li",{parentName:"ul"},"[3]"," ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/cosmos/cosmos-sdk/pull/17421"},"https://github.com/cosmos/cosmos-sdk/pull/17421")),(0,a.kt)("li",{parentName:"ul"},"[4]"," ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/cosmos/cosmos-sdk/pull/17713"},"https://github.com/cosmos/cosmos-sdk/pull/17713"))))}p.isMDXComponent=!0}}]);